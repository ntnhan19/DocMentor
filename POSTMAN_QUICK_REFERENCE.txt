==========================================================================
  DOCMENTOR API - POSTMAN TESTING GUIDE
==========================================================================

STEP 1: START SERVER
====================
Windows:
  -> Double-click: RUN_API.bat
  
Linux/Mac:
  -> chmod +x RUN_API.sh && ./RUN_API.sh

Manual:
  -> cd backend
  -> python run.py
  
CHECK: http://localhost:8000/health should return 200 OK

==========================================================================

STEP 2: POSTMAN SETUP
=====================

A. Import Collection
   1. Open Postman
   2. File -> Import
   3. Select: DocMentor_API.postman_collection.json
   4. Click Import

B. Create Environment
   1. Click Environments (left sidebar)
   2. New -> Create new
   3. Name: "DocMentor Local"
   4. Add Variables:
      - base_url = http://localhost:8000
      - token = (leave empty, fills after login)
   5. Save

C. Select Environment
   1. Top right dropdown
   2. Choose "DocMentor Local"

==========================================================================

TESTING SEQUENCE (Copy-paste ready)
===================================

TEST 1: Health Check
-----
GET http://localhost:8000/health

Expected Response (200):
{
  "status": "healthy",
  "environment": "development",
  "ai": "Gemini 2.5 Flash"
}

---

TEST 2: Register User
-----
POST http://localhost:8000/auth/register

Headers:
Content-Type: application/json

Body (raw JSON):
{
  "email": "student@example.com",
  "password": "TestPassword123!",
  "full_name": "Test Student"
}

Expected Response (201):
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}

---

TEST 3: Login
-----
POST http://localhost:8000/auth/login

Headers:
Content-Type: application/json

Body (raw JSON):
{
  "email": "student@example.com",
  "password": "TestPassword123!"
}

Expected Response (200):
{
  "success": true,
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "email": "student@example.com",
    "name": "Test Student",
    "role": "student",
    "avatar": null
  },
  "message": "Dang nhap thanh cong!"
}

IMPORTANT: Copy the "access_token" value!
In Postman Environment: set token = <copied_token>

---

TEST 4: Get Current User
-----
GET http://localhost:8000/auth/me

Headers:
Authorization: Bearer {{token}}

Expected Response (200):
{
  "id": 1,
  "email": "student@example.com",
  "full_name": "Test Student",
  "role": "student",
  "created_at": "2025-11-16T10:00:00"
}

---

TEST 5: Upload Document
-----
POST http://localhost:8000/documents/upload

Headers:
Authorization: Bearer {{token}}

Body (form-data, NOT raw):
- key: file (type: File) -> Select your PDF/DOCX/TXT
- key: title (type: Text) -> "My Test Document"

Expected Response (201):
{
  "id": 1,
  "title": "My Test Document",
  "file_type": "pdf",
  "file_size": 524288,
  "processed": false,
  "created_at": "2025-11-16T10:00:00"
}

SAVE: document_id = 1 (use this in next tests)
WAIT: 30-60 seconds for processing!

---

TEST 6: Check Document Status
-----
GET http://localhost:8000/documents/1

Headers:
Authorization: Bearer {{token}}

Expected Response (200):
{
  "id": 1,
  "title": "My Test Document",
  "file_type": "pdf",
  "file_size": 524288,
  "processed": true,    <-- MUST BE TRUE!
  "created_at": "2025-11-16T10:00:00"
}

Repeat until "processed": true appears.

---

TEST 7: Generate Summary
-----
POST http://localhost:8000/analysis/summary

Headers:
Authorization: Bearer {{token}}
Content-Type: application/json

Body (raw JSON):
{
  "document_id": 1,
  "length": "medium"
}

Try all 3 lengths:
- "short" -> 5 sentences
- "medium" -> 1-2 paragraphs
- "long" -> detailed (3-4 paragraphs)

Expected Response (200):
{
  "document_id": 1,
  "document_title": "My Test Document",
  "summary": "Document summary text...",
  "length": "medium",
  "word_count": 150,
  "created_at": "2025-11-16T10:05:00"
}

---

TEST 8: Extract Key Concepts
-----
POST http://localhost:8000/analysis/concepts

Headers:
Authorization: Bearer {{token}}
Content-Type: application/json

Body (raw JSON):
{
  "document_id": 1,
  "max_concepts": 10
}

Expected Response (200):
{
  "document_id": 1,
  "document_title": "My Test Document",
  "concepts": [
    "Concept 1",
    "Concept 2",
    "Concept 3",
    ...
  ],
  "count": 10
}

---

TEST 9: Generate Quiz
-----
POST http://localhost:8000/analysis/quiz

Headers:
Authorization: Bearer {{token}}
Content-Type: application/json

Body (raw JSON):
{
  "document_id": 1,
  "num_questions": 3,
  "difficulty": "medium"
}

Try all difficulties:
- "easy"
- "medium"
- "hard"

Expected Response (200):
{
  "document_id": 1,
  "document_title": "My Test Document",
  "questions": [
    {
      "question": "What is...?",
      "options": [
        "A. Option 1",
        "B. Option 2",
        "C. Option 3",
        "D. Option 4"
      ],
      "correct": "A",
      "explanation": "Explanation..."
    }
  ],
  "difficulty": "medium",
  "total_questions": 3
}

---

TEST 10: Query Document (RAG)
-----
POST http://localhost:8000/query/

Headers:
Authorization: Bearer {{token}}
Content-Type: application/json

Body (raw JSON):
{
  "query_text": "What is the main topic of this document?",
  "document_ids": [1],
  "max_results": 5
}

Expected Response (200):
{
  "query_id": 10,
  "query_text": "What is the main topic of this document?",
  "answer": "This document is about...",
  "sources": [
    {
      "document_id": 1,
      "document_title": "My Test Document",
      "page_number": 1,
      "similarity_score": 0.95,
      "text": "Relevant text from document..."
    }
  ],
  "processing_time_ms": 2500,
  "confidence_score": 0.92,
  "created_at": "2025-11-16T10:10:00"
}

SAVE: query_id = 10 (for feedback test)

---

TEST 11: Get Query History
-----
GET http://localhost:8000/query/history?skip=0&limit=20

Headers:
Authorization: Bearer {{token}}

Query Parameters:
- skip: 0
- limit: 20
- search: (optional)
- sort_by: date (or rating, relevance)
- order: desc (or asc)
- date_from: 2025-11-16 (optional)
- date_to: 2025-11-17 (optional)

Expected Response (200):
{
  "queries": [
    {
      "query_id": 10,
      "query_text": "...",
      "answer": "...",
      "sources": [...],
      "processing_time_ms": 2500,
      "confidence_score": 0.92,
      "created_at": "2025-11-16T10:10:00"
    }
  ],
  "total": 1
}

---

TEST 12: Submit Feedback
-----
POST http://localhost:8000/query/feedback

Headers:
Authorization: Bearer {{token}}
Content-Type: application/json

Body (raw JSON):
{
  "query_id": 10,
  "rating": 5,
  "feedback_text": "Great answer! Very helpful."
}

Expected Response (200):
{
  "message": "Feedback submitted successfully"
}

---

TEST 13: Delete Query
-----
DELETE http://localhost:8000/query/10

Headers:
Authorization: Bearer {{token}}

Expected Response (200):
{
  "message": "Query deleted successfully",
  "deleted_id": 10
}

---

TEST 14: Get Document Statistics
-----
GET http://localhost:8000/documents/stats

Headers:
Authorization: Bearer {{token}}

Expected Response (200):
{
  "total_documents": 1,
  "total_chunks": 10,
  "storage_mb": 5.2
}

---

TEST 15: Get Query Statistics
-----
GET http://localhost:8000/query/stats

Headers:
Authorization: Bearer {{token}}

Expected Response (200):
{
  "total_queries": 1,
  "avg_rating": 5.0,
  "activity_last_7_days": [
    {"date": "2025-11-16", "count": 1},
    {"date": "2025-11-15", "count": 0},
    ...
  ]
}

==========================================================================

ERROR CODES & SOLUTIONS
=======================

200 OK
  -> Success, response body has data

201 Created
  -> Success, resource created (usually POST)

204 No Content
  -> Success, no response body (usually DELETE)

400 Bad Request
  -> Invalid request body
  -> Check JSON syntax and required fields
  -> Example: missing "document_id" in summary request

401 Unauthorized
  -> Token missing or invalid
  -> Solution: Login again, copy new token to {{token}}

404 Not Found
  -> Resource doesn't exist
  -> Check if document_id or query_id is correct
  -> Try: GET /documents/ to list all

422 Validation Error
  -> Request data validation failed
  -> Check field types (int, string, etc)
  -> Check field constraints (min, max values)

500 Server Error
  -> Backend error
  -> Check server logs in terminal
  -> Common causes:
     - Gemini API key invalid
     - Database connection failed
     - Pinecone connection failed

==========================================================================

HELPFUL POSTMAN TIPS
====================

1. Auto-Extract Token
   After login, go to Tests tab:
   var jsonData = pm.response.json();
   pm.environment.set("token", jsonData.access_token);
   (Already configured in collection!)

2. Use Variables
   {{base_url}}     -> http://localhost:8000
   {{token}}        -> Your JWT token
   {{document_id}}  -> Document ID
   {{query_id}}     -> Query ID

3. Pretty Print Response
   Click "Pretty" button below response

4. Save Response as Example
   ... (menu) -> Save as example

5. Create Test Suite
   Run multiple requests in sequence:
   Runner -> Select folder -> Start

6. Export Results
   Runner -> Export Results (as JSON)

==========================================================================

POSTMAN COLLECTION STRUCTURE
============================

AuthenticationSection
├── Register
├── Login
└── Get Current User

Documents Section
├── Upload Document
├── List All Documents
├── Get Document Detail
├── Update Document
├── Delete Document
└── Get Document Stats

Query & RAG Section
├── Query Documents
├── Get Query History
├── Get Query Detail
├── Submit Feedback
├── Delete Query
└── Get Query Stats

Analysis Section
├── Generate Summary
├── Extract Key Concepts
└── Generate Quiz

Utilities Section
├── Health Check
└── API Root Info

==========================================================================

EXAMPLE: COMPLETE FLOW (Copy & Paste)
=====================================

1. Health Check
   GET http://localhost:8000/health

2. Register
   POST http://localhost:8000/auth/register
   {
     "email": "demo@example.com",
     "password": "Demo123!@",
     "full_name": "Demo User"
   }

3. Login (COPY TOKEN!)
   POST http://localhost:8000/auth/login
   {
     "email": "demo@example.com",
     "password": "Demo123!@"
   }

4. Upload Sample PDF
   POST http://localhost:8000/documents/upload
   [select any PDF file]
   title: "Sample"

5. Wait 30 seconds...

6. Summary
   POST http://localhost:8000/analysis/summary
   {"document_id": 1, "length": "medium"}

7. Concepts
   POST http://localhost:8000/analysis/concepts
   {"document_id": 1, "max_concepts": 10}

8. Quiz
   POST http://localhost:8000/analysis/quiz
   {"document_id": 1, "num_questions": 5, "difficulty": "medium"}

9. RAG Query
   POST http://localhost:8000/query/
   {
     "query_text": "Summarize this document",
     "document_ids": [1],
     "max_results": 5
   }

Done! All features tested!

==========================================================================

.ENV FILE REQUIREMENTS
======================

FILE: backend/.env

DATABASE_URL=postgresql://postgres:21092004@localhost:5432/DocMentor
SECRET_KEY=your-secret-key-at-least-32-characters-long
GEMINI_API_KEY=your-gemini-api-key-from-ai.google.dev
PINECONE_API_KEY=your-pinecone-api-key-from-pinecone.io
PINECONE_INDEX_NAME=docmentor
ENVIRONMENT=development

==========================================================================

NEXT STEPS AFTER TESTING
=========================

1. Test with your own documents
2. Try different analysis options
3. Check RAG quality with various questions
4. Rate responses and collect feedback
5. Monitor processing times in logs
6. Prepare for deployment

For deployment guide, see README_FULL.md

==========================================================================

NEED HELP?
==========

1. Check logs in terminal running the server
2. Read: POSTMAN_TESTING_GUIDE.md (full details)
3. Read: QUICK_START.md (step-by-step)
4. Read: README_FULL.md (complete documentation)
5. Swagger UI: http://localhost:8000/docs (after server starts)

==========================================================================

TEST CHECKLIST
==============

[ ] Server running (http://localhost:8000/health = 200)
[ ] Postman collection imported
[ ] Environment created: "DocMentor Local"
[ ] base_url set: http://localhost:8000
[ ] Health check passed
[ ] User registered
[ ] User logged in, token copied
[ ] Document uploaded
[ ] Waited for processing (processed=true)
[ ] Summary generated
[ ] Concepts extracted
[ ] Quiz generated
[ ] RAG query answered
[ ] Feedback submitted
[ ] Query history viewed
[ ] All error codes understood

All checked? You're ready to use DocMentor API!

==========================================================================
